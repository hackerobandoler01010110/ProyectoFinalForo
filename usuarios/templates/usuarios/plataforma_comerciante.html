{% load static %}
<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Plataforma de Comerciantes</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    
    <script id="tailwind-config">
        tailwind.config = {
          darkMode: "class",
          theme: {
            extend: {
              colors: {
                "primary": "#005A9C",
                "secondary": "#FF9800",
                "background-light": "#F4F6F8",
                "background-dark": "#101c22",
                "text-light": "#333333",
                "text-dark": "#F4F6F8",
                "text-muted-light": "#666666",
                "text-muted-dark": "#a0aec0",
              },
              fontFamily: {
                "display": ["Work Sans", "sans-serif"],
              },
              borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
            },
          },
        }
    </script>
    
    <style>
        .off-canvas-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%); /* Oculto a la derecha */
        }
        .off-canvas-panel.active {
            transform: translateX(0); /* Visible */
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap bg-white dark:bg-background-dark border-b border-solid border-gray-200 dark:border-gray-700 px-10 py-3 shadow-sm sticky top-0 z-50">
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-3">
                        <img src="{% static 'img/logoClubAlmacen.png' %}" alt="Logo de la Plataforma" class="h-24 w-auto"/>
                    </div>
                </div>
                <div class="flex-1 max-w-lg mx-auto">
                    <label class="flex flex-col min-w-40 !h-10 max-w-full">
                        <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                            <div class="text-text-muted-light dark:text-text-muted-dark flex border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 items-center justify-center pl-4 rounded-l-lg border-r-0">
                                <span class="material-symbols-outlined">search</span>
                            </div>
                            <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light dark:text-text-dark focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:border-primary h-full placeholder:text-text-muted-light dark:placeholder:text-text-muted-dark px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" placeholder="Buscar en la plataforma..." value=""/>
                        </div>
                    </label>
                </div>
                <div class="flex justify-end gap-4 items-center">
                    <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 bg-transparent text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-gray-700">
                        <span class="material-symbols-outlined text-2xl">notifications</span>
                    </button>
                    <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 bg-transparent text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-gray-700">
                        <span class="material-symbols-outlined text-2xl">settings</span>
                    </button>
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="User profile picture" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDHvwpnyqsHNE26vkYQRDmOsew1FmzE3huwOaXD81x6WwS7HFCzXdHlZUvxWPCLNDmbF_WpXbtsYq3_IhaPtE2CX7wkVRRZ-VeelbmqdGL2EBD3TKyZh52brWhNx8fpI8AUeqVTjCvLo2B2fhwjfL5C8GcEM7SS0_dEc_6Fp-Yhs0vZ5qfHKjCBte92VGlDQ9-2Hby5UgjwJ_1vulv4AOkL4JrTAYhgnVkJfISkGR40K2CPcLxNYRM0SSdi7tcnRjjjq-oGW3MyzQ");'></div>
                </div>
            </header>
            
            <main class="flex-1 w-full max-w-screen-2xl mx-auto p-6 lg:p-8">
                {% if messages %}
                    <div class="mb-6">
                    {% for message in messages %}
                        <div class="p-3 rounded-lg text-sm {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300{% elif message.tags == 'success' %}bg-green-100 text-green-700 border border-green-300{% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %} mb-2">
                            {{ message }}
                        </div>
                    {% endfor %}
                    </div>
                {% endif %}

                <div class="grid grid-cols-12 gap-8">
                    
                    <aside class="col-span-12 lg:col-span-3 order-2 lg:order-1">
                        <div class="space-y-8">
                            <div class="bg-white dark:bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="text-text-light dark:text-text-dark text-lg font-bold mb-4">Accesos Rápidos</h3>
                                <div class="flex flex-col gap-2">
                                    <a class="flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 text-text-light dark:text-text-dark transition-colors duration-200" href="#">
                                        <span class="material-symbols-outlined text-primary text-2xl">star</span>
                                        <p class="font-medium">Beneficios</p>
                                    </a>
                                    <a class="flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 text-text-light dark:text-text-dark transition-colors duration-200" href="#">
                                        <span class="material-symbols-outlined text-primary text-2xl">groups</span>
                                        <p class="font-medium">Proveedores</p>
                                    </a>
                                    <a class="flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 text-text-light dark:text-text-dark transition-colors duration-200" href="#">
                                        <span class="material-symbols-outlined text-primary text-2xl">build</span>
                                        <p class="font-medium">Herramientas</p>
                                    </a>
                                    <a class="flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 text-text-light dark:text-text-dark transition-colors duration-200" href="#">
                                        <span class="material-symbols-outlined text-primary text-2xl">school</span>
                                        <p class="font-medium">Capacitación</p>
                                    </a>
                                    <a class="flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 text-text-light dark:text-text-dark transition-colors duration-200" href="#">
                                        <span class="material-symbols-outlined text-primary text-2xl">help</span>
                                        <p class="font-medium">Ayuda</p>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <main class="col-span-12 lg:col-span-6 order-1 lg:order-2">
                        <div class="space-y-8">
                            <div class="bg-white dark:bg-white rounded-xl shadow-sm p-6">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                                    <h1 class="text-text-light dark:text-text-dark text-2xl font-bold tracking-[-0.015em] shrink-0">Foro</h1>
                                    
                                    <div class="flex flex-col sm:flex-row gap-4 items-center justify-end w-full sm:w-auto">
                                        
                                        <div class="relative w-full lg:w-48">
                                            <button type="button" 
                                                    id="filter-toggle-btn"
                                                    class="flex justify-between items-center w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-text-light dark:text-text-dark font-semibold border border-gray-300 dark:border-gray-600"
                                                    onclick="toggleFilter('category-checklist-content', 'filter-icon-btn')">
                                                <span>Filtrar</span>
                                                <span id="filter-icon-btn" class="material-symbols-outlined text-base transition-transform duration-300">add</span>
                                            </button>

                                            <form method="GET" action="{% url 'plataforma_comerciante' %}" id="category-checklist-content" class="absolute right-0 mt-1 z-10 hidden w-full lg:w-48 p-3 rounded-lg shadow-xl bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 space-y-2">
                                                
                                                <p class="text-sm font-medium text-text-light dark:text-text-dark mb-1 border-b pb-1">Seleccionar Categorías:</p>

                                                <label class="flex items-center space-x-3">
                                                    <input type="checkbox" name="categoria" value="TODAS" 
                                                           class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary"
                                                           {% if 'TODAS' in categoria_seleccionada or not categoria_seleccionada %}checked{% endif %}
                                                           onclick="document.querySelectorAll('#category-checklist-content input[name=categoria]').forEach(cb => { if(cb.value !== 'TODAS') cb.checked = false; });">
                                                    <span class="text-sm text-text-light dark:text-text-dark">Todas</span>
                                                </label>
                                                
                                                {% for key, value in CATEGORIA_POST_CHOICES %}
                                                    <label class="flex items-center space-x-3">
                                                        <input type="checkbox" name="categoria" value="{{ key }}" 
                                                               class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary"
                                                               {% if key in categoria_seleccionada and 'TODAS' not in categoria_seleccionada %}checked{% endif %}
                                                               onclick="document.querySelector('#category-checklist-content input[value=TODAS]').checked = false;">
                                                        <span class="text-sm text-text-light dark:text-text-dark">{{ value }}</span>
                                                    </label>
                                                {% endfor %}

                                                <button type="submit" class="mt-4 w-full h-8 bg-primary text-white text-sm rounded hover:bg-primary/90 transition-colors">
                                                    Aplicar Filtro
                                                </button>
                                            </form>
                                        </div>
                                        <button onclick="document.getElementById('off-canvas-publicar').classList.add('active');" 
                                                class="min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-secondary text-white gap-2 text-base font-bold leading-normal tracking-[0.015em] hover:bg-secondary/90 transition-colors duration-200 hidden sm:flex">
                                            <span class="material-symbols-outlined">add</span>
                                            <span class="truncate">Crear publicación</span>
                                        </button>
                                    </div>
                                    </div>
                                
                                <div class="space-y-4">
                                    {% for post in posts %}
                                        <div class="flex gap-4 bg-transparent dark:bg-gray-800 p-4 justify-between border-t border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg -mx-4">
                                            <div class="flex items-start gap-4">
                                                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" 
                                                     data-alt="Avatar de {{ post.comerciante.nombre_apellido }}" 
                                                     style='background-image: url("http://googleusercontent.com/profile/picture/{{ forloop.counter }}");'></div>
                                                <div class="flex flex-1 flex-col justify-center">
                                                    <p class="text-xs font-medium uppercase text-primary mb-1">{{ post.get_categoria_display }}</p>
                                                    <p class="text-text-light dark:text-text-dark text-base font-semibold leading-normal hover:text-primary cursor-pointer">{{ post.titulo }}</p>
                                                    <p class="text-text-muted-light dark:text-text-muted-dark text-sm font-normal leading-normal mt-1 truncate max-w-full">{{ post.contenido|truncatechars:100 }}</p>
                                                    
                                                    {% if post.imagen_url %}
                                                        <a href="{{ post.imagen_url }}" target="_blank" class="text-primary text-xs font-bold mt-1 inline-block hover:underline">Ver Imagen/Link</a>
                                                    {% endif %}

                                                    <p class="text-text-muted-light dark:text-text-muted-dark text-xs font-normal leading-normal mt-2">
                                                        {{ post.comerciante.nombre_apellido }} - {{ post.fecha_publicacion|timesince }}
                                                        {% if post.etiquetas %}
                                                            <span class="ml-2 text-primary/70">Etiquetas: {{ post.etiquetas }}</span>
                                                        {% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="shrink-0 flex flex-col items-end justify-center text-sm text-text-muted-light dark:text-text-muted-dark">
                                                <div class="flex items-center gap-1">
                                                    <span class="material-symbols-outlined text-base">forum</span>
                                                    <span>0</span>
                                                </div>
                                                <div class="flex items-center gap-1">
                                                    <span class="material-symbols-outlined text-base">thumb_up</span>
                                                    <span>0</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% empty %}
                                        <div class="p-4 text-center text-text-muted-light dark:text-text-muted-dark">
                                            Aún no hay publicaciones en esta categoría. ¡Sé el primero en crear una!
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </main>

                    <aside class="col-span-12 lg:col-span-3 order-3">
                        <div class="space-y-8">
                            <div class="bg-white dark:bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="text-text-light dark:text-text-dark text-lg font-bold mb-4">Últimas Noticias</h3>
                                <div class="space-y-4">
                                    <div class="flex gap-4 items-center">
                                        <img class="w-20 h-20 object-cover rounded-lg" data-alt="People in a meeting room" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDw4lC1vSvwceI-qO4vPrManCM4dXbqa79FpaZGZRXJVq3cs4Bm294sTJndABNYnOHpWfm-3QczNaSIYsJMM-M3Ff3teeR5pJR1sOjLSe5f5avdSCCT8z1iIJlf5qhYI7AsJqFbzG1hqj5N5TLX-BV20NBaDUgMSsTIrWIvjVlKe1FFJlnvB-9TVSCGFhfVIdQ3naPfljcnsOR0w13jsFF395orHcaRhHSthWU9M5h6LR1q4BZJgmBfi0hGbpddmYeOW1TAyCU7GQ"/>
                                        <div>
                                            <p class="text-text-light dark:text-text-dark font-semibold text-sm leading-tight">Ayuntamiento lanza nuevas ayudas para el comercio local</p>
                                            <a class="text-primary text-xs font-bold mt-1 inline-block" href="#">Leer más</a>
                                        </div>
                                    </div>
                                    <div class="flex gap-4 items-center">
                                        <img class="w-20 h-20 object-cover rounded-lg" data-alt="Person paying with a phone" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCSSAxeP4eS2YJLWORYxKZ2D94v4mIbwiqjqgP1xX19yT6dmL2jb-Axv4MosM37ZE99DSfZveQgpm-itm8NYhOXWaxqVrcoxL20U25I-Ll2QVtBmj8U1G_3f1u5HlblZ-FWOO75589irXaVHkF-GXtpEvfg13Hhu3V3vic0_VWgonvuYaPygNJ9boA20hRWkHx7zZQQS8brKPopoAzPB-lbW9ipOv1RcHx_03Yfsa6QFFSl--Br8nVu-r6On8FwpIhFaBbsUikmvw"/>
                                        <div>
                                            <p class="text-text-light dark:text-text-dark font-semibold text-sm leading-tight">Tendencias de consumo para el próximo trimestre</p>
                                            <a class="text-primary text-xs font-bold mt-1 inline-block" href="#">Leer más</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="text-text-light dark:text-text-dark text-lg font-bold mb-4">Próximos Eventos</h3>
                                <div class="space-y-4">
                                    <div class="flex gap-4">
                                        <div class="flex flex-col items-center justify-center bg-primary/10 dark:bg-primary/20 text-primary rounded-lg p-2 w-16 h-16 shrink-0">
                                            <span class="text-sm font-bold">JUL</span>
                                            <span class="text-2xl font-bold">25</span>
                                        </div>
                                        <div>
                                            <p class="text-text-light dark:text-text-dark font-semibold">Taller Online: Marketing en Redes Sociales</p>
                                            <p class="text-text-muted-light dark:text-text-muted-dark text-sm">18:00 - Online</p>
                                            <a class="text-primary text-xs font-bold mt-1 inline-block" href="#">Ver detalles</a>
                                        </div>
                                    </div>
                                    <div class="flex gap-4">
                                        <div class="flex flex-col items-center justify-center bg-primary/10 dark:bg-primary/20 text-primary rounded-lg p-2 w-16 h-16 shrink-0">
                                            <span class="text-sm font-bold">AGO</span>
                                            <span class="text-2xl font-bold">12</span>
                                        </div>
                                        <div>
                                            <p class="text-text-light dark:text-text-dark font-semibold">Reunión Mensual de Comerciantes - Zona Centro</p>
                                            <p class="text-text-muted-light dark:text-text-muted-dark text-sm">19:30 - Centro Cívico</p>
                                            <a class="text-primary text-xs font-bold mt-1 inline-block" href="#">Ver detalles</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </main>
        </div>
    </div>
    
    <div class="fixed bottom-0 left-0 w-full p-4 lg:hidden z-40 bg-background-light dark:bg-background-dark border-t border-gray-200 dark:border-gray-700 shadow-lg">
        <button onclick="document.getElementById('off-canvas-publicar').classList.add('active');" 
                class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-secondary text-white gap-2 text-base font-bold leading-normal tracking-[0.015em] hover:bg-secondary/90 transition-colors duration-200">
            <span class="material-symbols-outlined">add</span>
            <span class="truncate">Crear publicación en el Foro</span>
        </button>
    </div>

    <div id="off-canvas-publicar" class="off-canvas-panel fixed top-0 right-0 w-full sm:w-1/2 lg:w-1/3 h-full bg-white dark:bg-white z-50 shadow-2xl overflow-y-auto p-6 flex flex-col">
        <div class="flex justify-between items-center pb-4 mb-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-2xl font-bold text-text-light dark:text-text-dark">Crear Nueva Publicación</h3>
            <button onclick="document.getElementById('off-canvas-publicar').classList.remove('active');" 
                    class="text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-3xl">close</span>
            </button>
        </div>

        <form method="POST" action="{% url 'crear_publicacion' %}" enctype="multipart/form-data" class="space-y-4 flex-grow flex flex-col">
            {% csrf_token %}
            
            <div>
                <label for="{{ post_form.titulo.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{{ post_form.titulo.label }}</label>
                {{ post_form.titulo }}
                {% for error in post_form.titulo.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <div>
                <label for="{{ post_form.categoria.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{{ post_form.categoria.label }}</label>
                {{ post_form.categoria }}
                {% for error in post_form.categoria.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <div>
                <label for="{{ post_form.contenido.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{{ post_form.contenido.label }}</label>
                <textarea name="{{ post_form.contenido.name }}" id="{{ post_form.contenido.id_for_label }}"
                    placeholder="{{ post_form.contenido.field.widget.attrs.placeholder }}" rows="5"
                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light dark:text-text-dark focus:outline-0 focus:ring-2 focus:ring-primary border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:border-primary placeholder:text-text-muted-light dark:placeholder:text-text-muted-dark p-[10px] text-base font-normal leading-normal max-h-48 min-h-24">
                </textarea>
                {% for error in post_form.contenido.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <div>
                <label for="{{ post_form.uploaded_file.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{{ post_form.uploaded_file.label }}</label>
                {{ post_form.uploaded_file }}
                <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1">Sube un archivo desde tu PC.</p>
                {% for error in post_form.uploaded_file.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>
            
            <div>
                <label for="{{ post_form.url_link.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{{ post_form.url_link.label }}</label>
                {{ post_form.url_link }}
                <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1">Opcional: URL de una imagen o link externo.</p>
                {% for error in post_form.url_link.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <div>
                <label for="{{ post_form.etiquetas_input.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{{ post_form.etiquetas_input.label }}</label>
                {{ post_form.etiquetas_input }}
                <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1">{{ post_form.etiquetas_input.help_text }}</p>
                {% for error in post_form.etiquetas_input.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>
            
            <div class="pt-4 mt-auto border-t border-gray-200 dark:border-gray-700">
                <button type="submit" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] w-full transition-transform hover:scale-[1.01]">
                    <span class="truncate">Publicar en el Foro</span>
                </button>
            </div>
        </form>
    </div>
<script>
    function toggleFilter(contentId, iconId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);
        
        // Toggle visibility
        content.classList.toggle('hidden');
        
        // Change icon (add/remove)
        if (content.classList.contains('hidden')) {
            icon.textContent = 'add';
        } else {
            icon.textContent = 'remove';
        }
    }
</script>
</body>
</html>